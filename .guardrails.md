# üö® GUARDRAILS: TUI Testing & Terminal Apps

**FOR LLM ASSISTANTS: These rules must be followed in every session. No exceptions.**

## Rule 1: NEVER Use `timeout` on TUI Applications

**Status**: MANDATORY - Violating this breaks developer terminal state

### The Rule
```
‚ùå FORBIDDEN:
timeout 5 bun run dev
timeout 10 npm start
timeout N <any-tui-app>
```

### Why
- TUI apps manage terminal "raw mode" for keyboard input
- `timeout` forcibly kills the process before cleanup runs
- This leaves the terminal broken: no input echo, no cursor visibility
- Developer must restart their shell to fix it

### The Only Correct Way
```typescript
// In code: Use Bun.spawn() + SIGINT only
const proc = Bun.spawn(["bun", "run", "dev"], {...});
process.kill(proc.pid, "SIGINT");  // Only this
```

```bash
# In CLI: Run and Ctrl+C manually
bun run dev
# User presses Ctrl+C
```

## Rule 2: Ctrl Event Loop with Proper Exit Handling

**Status**: IMPLEMENTED - Working correctly

### The Pattern
```typescript
// ‚úÖ CORRECT - Blocking while loop works with OpenTUI's event system
// OpenTUI's keyInput event handler keeps the process alive
// The while loop simply waits for the shouldExit flag
while (!shouldExit) {
  await new Promise(resolve => setTimeout(resolve, 100));
}

// Critical cleanup sequence:
// 1. Call renderer.destroy() to restore terminal state
// 2. Call process.exit(0) immediately after
// 3. NO setTimeout/race conditions in cleanup
```

### Implementation Location
File: `src/ui/renderer.tsx:500-516`

**Current working implementation:**
- Line 480-487: keyInput event handler sets `shouldExit` flag
- Line 500-502: Event loop waits for exit flag
- Line 504-516: Critical exit cleanup sequence
- Exit is clean: no terminal artifacts, shell prompt works correctly

## Rule 3: Test TUI Apps Only With Proper Event Loop Handling

**Status**: TECHNICAL - Tests must not use timeout

### Correct Test Pattern
```typescript
const proc = Bun.spawn(["bun", "run", "dev"], {
  stdout: "pipe",
  stderr: "pipe",
});

// Wait for initialization WITHOUT timeout
await new Promise(resolve => setTimeout(resolve, 3000));

// Check if still alive (no timeout command used)
const isAlive = !proc.exited;
expect(isAlive).toBe(true);

// EXIT ONLY WITH SIGINT
process.kill(proc.pid, "SIGINT");
await new Promise(resolve => setTimeout(resolve, 500));
```

### In bun test with Custom Timeouts
```typescript
// Set a reasonable timeout for the test itself, but don't use bash timeout
it("should run", async () => {
  // bun test will apply its default timeout
  // Inside, spawn + SIGINT only
  const proc = Bun.spawn(...);
  // ... test logic ...
  process.kill(proc.pid, "SIGINT");
}, { timeout: 30000 }); // bun test timeout, not bash timeout
```

## Rule 4: Read These Files First Every Session

**Status**: NAVIGATION - These are the critical reference docs

1. **docs/ctrl-specific-constraints.md** (Section G.0) - TUI Testing rules
2. **docs/development-guide.md** (Section "Testing TUI Apps") - How to test properly
3. **docs/testing.md** (Section "Testing TUI Applications") - Detailed test examples
4. **.guardrails.md** (THIS FILE) - LLM-specific rules

## Checklist: Before Running Any Test

- [ ] Is this a TUI app (terminal UI using OpenTUI)?
- [ ] Am I using `timeout`, `kill -9`, or any force-kill? ‚Üí STOP, use SIGINT only
- [ ] Am I spawning with Bun.spawn? ‚Üí Yes, this is correct
- [ ] Am I sending SIGINT only to exit? ‚Üí Yes, this is correct
- [ ] Have I read the test examples in docs/testing.md? ‚Üí Reference them

## References

**Core Documentation (MUST READ):**
- CLAUDE.md - Project instructions (read first in every session)
- docs/ctrl-specific-constraints.md - Complete TUI constraints
- docs/development-guide.md - Development patterns
- docs/testing.md - Testing guidelines with examples

**Current Implementation:**
- src/ui/renderer.tsx - Event loop and exit cleanup (lines 480-516) ‚úÖ working
- test/tui.test.ts - Example tests using proper SIGINT handling
- src/main.tsx - App initialization
- src/config/watcher.ts - Config hot-reload with dual-mode watching ‚úÖ working

**OpenTUI References:**
- GitHub: https://github.com/anomalyco/opentui - Frame-based event loop
- GitHub: https://github.com/anomalyco/opencode - Real implementation example

## For Session Context

**Implementation Status: ‚úÖ COMPLETE**

The Ctrl event loop is working correctly:
- OpenTUI's keyInput event handler keeps the process alive
- The blocking while loop in renderer.tsx (lines 500-502) properly waits for exit
- Exit cleanup sequence (lines 504-516) restores terminal state cleanly
- No shell artifacts after exit, prompt works correctly

**Tests:**
- test/tui.test.ts: First test passes, verifies clean exit
- Tests properly use SIGINT only (no timeout)
- No broken renderer initialization issues to fix

---

**Last Updated:** January 23, 2026
**Enforcement:** MANDATORY for all LLM sessions
**Violation Impact:** Breaks developer's terminal state (for Rule 1)

**Status Note:** Rule 2 event loop issue has been resolved. App stays running correctly.
